<link rel="import" href="../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../bower_components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="../bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="../bower_components/core-icon-button/core-icon-button.html">
<link rel="import" href="../bower_components/core-icon/core-icon.html">
<link rel="import" href="../bower_components/core-icons/core-icons.html">
<link rel="import" href="../bower_components/core-icons/iconsets/av-icons.html">
<link rel="import" href="../bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="../bower_components/font-roboto/roboto.html">
<link rel="import" href="../bower_components/google-youtube/google-youtube.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../bower_components/paper-shadow/paper-shadow.html">
<link rel="import" href="../bower_components/polymer/polymer.html">


<!--
A video wall with material design styling.
It uses [YouTube Data API v3](https://developers.google.com/youtube/v3/)
searches to populate the list of videos.

##### Example

    <google-youtube-video-wall></google-youtube-video-wall>

@element google-youtube-video-wall
@blurb An element for displaying collections of YouTube videos.
@status alpha
@homepage https://github.com/googlewebcomponents/google-youtube-video-wall
-->

<polymer-element name="google-youtube-video-wall"
                 attributes="headerTitle maxVideos keySearchParam channelIdSearchParam locationSearchParam locationRadiusSearchParam maxResultsSearchParam orderSearchParam publishedAfterSearchParam publishedBeforeSearchParam qSearchParam safeSearchSearchParam topicIdSearchParam videoCategoryIdSearchParam">
  <template>
    <link rel="stylesheet" href="google-youtube-video-wall.css" />

    <core-animated-pages id="corepage"
                         transitions="hero-transition cross-fade"
                         selected="0"
                         on-core-animated-pages-transition-end="{{handleTransitionEnd}}">
      <section>
        <core-header-panel cross-fade>
          <core-toolbar>
            <header>{{headerTitle}}</header>
          </core-toolbar>

          <div id="searchresults">
            <template repeat="{{video in videos}}">
              <div class="video-container"
                       data-video-id="{{video.id.videoId}}"
                       data-video-title="{{video.snippet.title}}"
                       data-video-background-url="{{video.snippet.thumbnails.high.url}}"
                       on-tap="{{handleItemSelected}}">
                <paper-shadow z="1"></paper-shadow>
                <paper-ripple fit></paper-ripple>

                <img src="{{video.snippet.thumbnails.medium.url}}" hero-id="{{video.id.videoId}}" hero>
                <h1>{{video.snippet.title}}</h1>
                <p>{{video.snippet.description}}</p>
              </div>
            </template>
          </div>
        </core-header-panel>
      </section>

      <section>
        <div cross-fade>
          <template if="{{selectedVideoId}}">
            <google-youtube videoid="{{selectedVideoId}}"
                            chromeless
                            width="{{playerWidth}}"
                            height="{{playerHeight}}"
                            currenttime="{{currentTime}}"
                            fractionloaded="{{fractionLoaded}}"
                            state="{{state}}"
                            duration="{{duration}}"
                            hero-id="{{selectedVideoId}}"
                            hero>
            </google-youtube>
          </template>

          <paper-slider id="seekbar"
                        min="0"
                        max="{{duration}}"
                        value="{{currentTime}}"
                        secondaryProgress="{{ fractionLoaded * duration }}"
                        on-manual-change="{{handleSeekTo}}">
          </paper-slider>

          <core-toolbar id="playercontrols">
            <paper-fab class="mini" icon="arrow-back" on-tap="{{handlePlayerClose}}"></paper-fab>

            <template if="{{state == 1 || state == 3}}">
              <paper-fab class="mini" icon="av:pause" on-tap="{{handlePause}}"></paper-fab>
            </template>
            <template if="{{state != 1 && state != 3}}">
              <paper-fab class="mini" icon="av:play-arrow" on-tap="{{handlePlay}}"></paper-fab>
            </template>

            <p flex>{{selectedVideoTitle}}</p>
          </core-toolbar>
        </div>
      </section>
    </core-animated-pages>

    <template if="{{searchParams}}">
      <core-ajax auto
                 url="https://www.googleapis.com/youtube/v3/search"
                 params="{{searchParams}}"
                 handleAs="json"
                 on-core-response="{{handleSearchResponse}}">
      </core-ajax>
    </template>
  </template>

  <script>
    (function() {
      var SEARCH_PARAM_REGEX = /searchparam/i;

      Polymer('google-youtube-video-wall', {
        // TODO: Add JSDoc for the published attributes and clean up attribute names.
        headerTitle: 'YouTube Videos',
        maxItems: 500,
        keySearchParam: 'AIzaSyAcB7qNYPC6bI7e3PHscV8w5-acmocWhmE',
        channelIdSearchParam: '',
        locationSearchParam: '',
        locationRadiusSearchParam: '',
        maxResultsSearchParam: 50,
        orderSearchParam: 'relevance',
        publishedAfterSearchParam: '',
        publishedBeforeSearchParam: '',
        qSearchParam: '',
        safeSearchSearchParam: 'moderate',
        topicIdSearchParam: '',
        videoCategoryIdSearchParam: '',

        selectedVideoId: '',
        selectedVideoTitle: '',
        nextPageToken: '',
        youtubeApiSearchParams: '',

        updateYouTubeApiSearchParams: function() {
          var params = {
            part: 'snippet',
            pageToken: this.nextPageToken,
            type: 'video',
            videoEmbeddable: 'true',
            key: this.keySearchParam,
            maxResults: this.maxResultsSearchParam,
            channelId: this.channelIdSearchParam,
            location: this.locationSearchParam,
            locationRadius: this.locationRadiusSearchParam,
            order: this.orderSearchParam,
            q: this.qSearchParam,
            safeSearch: this.safeSearchSearchParam,
            topicId: this.topicIdSearchParam,
            videoCategoryId: this.videoCategoryIdSearchParam
          };

          Object.keys(params).forEach(function(key) {
            if (params[key] === '') {
              delete(params[key]);
            }
          });

          this.searchParams = JSON.stringify(params);
        },

        handleSearchResponse: function(e) {
          var response = e.detail.response;

          if (this.videos) {
            this.videos = this.videos.concat(response.items);
          } else {
            this.videos = response.items;
          }

          if (response.nextPageToken && this.videos.length < this.maxItems) {
            this.nextPageToken = response.nextPageToken;
            this.async(this.updateYouTubeApiSearchParams);
          }
        },

        handleItemSelected: function(e) {
          // The video player should be in a 16:9 aspect ratio.
          this.playerWidth = '100%';
          // We need to read the width of the container rather than rely on the width of the player
          // itself, because the player is not yet on the page.
          var containerWidth = this.$.corepage.offsetWidth;
          this.playerHeight = (containerWidth * 9 / 16) + 'px';

          this.selectedVideoId = e.srcElement.parentNode.dataset.videoId;
          this.selectedVideoTitle = e.srcElement.parentNode.dataset.videoTitle;
          this.$.corepage.selected = 1;
        },

        handlePlayerClose: function() {
          this.shadowRoot.querySelector('google-youtube').pause();
          this.$.corepage.selected = 0;

          this.state = -1;
          this.currentTime = 0;
          this.fractionLoaded = 0;
        },

        handlePlay: function() {
          this.shadowRoot.querySelector('google-youtube').play();
        },

        handlePause: function() {
          this.shadowRoot.querySelector('google-youtube').pause();
        },

        handleSeekTo: function() {
          console.log('here');
          this.shadowRoot.querySelector('google-youtube').seekTo(this.$.seekbar.value);
        },

        handleTransitionEnd: function() {
          // If we've transitioned from the player to the results page, reset selectedVideoId
          // so that the next <google-youtube> player element is "fresh".
          // We can't reset it prior to the transition since it will mess up the hero-id mapping.
          if (this.$.corepage.selected == 0) {
            this.selectedVideoId = '';
          }
        },

        attributeChanged: function(attrName, oldVal, newVal) {
          if (SEARCH_PARAM_REGEX.test(attrName)) {
            this.updateYouTubeApiSearchParams();
          }
        },

        ready: function() {
          this.updateYouTubeApiSearchParams();
        }
      });
    })();
  </script>
</polymer-element>
