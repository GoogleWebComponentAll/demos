<link rel="import" href="../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../bower_components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="../bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="../bower_components/core-icon-button/core-icon-button.html">
<link rel="import" href="../bower_components/core-icon/core-icon.html">
<link rel="import" href="../bower_components/core-icons/core-icons.html">
<link rel="import" href="../bower_components/core-icons/iconsets/av-icons.html">
<link rel="import" href="../bower_components/core-media-query/core-media-query.html">
<link rel="import" href="../bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="../bower_components/font-roboto/roboto.html">
<link rel="import" href="../bower_components/google-youtube/google-youtube.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../bower_components/paper-shadow/paper-shadow.html">
<link rel="import" href="../bower_components/polymer/polymer.html">


<!--
A video wall with material design styling.
It uses [YouTube Data API v3](https://developers.google.com/youtube/v3/)
searches to populate the list of videos.

##### Example

    <google-youtube-video-wall></google-youtube-video-wall>

@element google-youtube-video-wall
@blurb An element for displaying collections of YouTube videos.
@status alpha
@homepage https://github.com/googlewebcomponents/google-youtube-video-wall
-->

<polymer-element name="google-youtube-video-wall"
                 attributes="headerTitle showSearch maxVideos key channelId location locationRadius maxResults order publishedAfter publishedBefore q safeSearch topicId videoCategoryId">
  <template>
    <link rel="stylesheet" href="google-youtube-video-wall.css" />

    <core-media-query query="max-width: 600px" queryMatches="{{narrow}}"></core-media-query>
    <core-media-query query="max-width: 400px" queryMatches="{{veryNarrow}}"></core-media-query>

    <core-animated-pages id="corepage"
                         transitions="hero-transition cross-fade"
                         selected="0"
                         on-core-animated-pages-transition-end="{{handleTransitionEnd}}">
      <section>
        <core-header-panel cross-fade>
          <core-toolbar class="{{ {'medium-tall': narrow} | tokenList }}">
            <core-icon icon="av:video-youtube"></core-icon>
            <header flex>{{headerTitle}}</header>

            <template if="{{showSearch}}">
              <core-icon icon="search" class="{{ {bottom: narrow} | tokenList }}"></core-icon>
              <paper-input class="{{ {bottom: narrow} | tokenList }}"
                           placeholder="Search for..."
                           value="{{q}}"
                           style="margin-top: 20px;">
              </paper-input>
            </template>
          </core-toolbar>

          <div id="searchresults" class="{{ {veryNarrow: veryNarrow} | tokenList }}">
            <template repeat="{{video in videos}}">
              <div class="video-container"
                       data-video-id="{{video.id.videoId}}"
                       data-video-title="{{video.snippet.title}}"
                       data-video-background-url="{{video.snippet.thumbnails.high.url}}"
                       on-tap="{{handleItemSelected}}">
                <paper-shadow z="1"></paper-shadow>
                <paper-ripple></paper-ripple>

                <img src="{{video.snippet.thumbnails.medium.url}}"
                     hero-id="{{video.id.videoId}}"
                     hero>
                <h1>{{video.snippet.title}}</h1>
                <p>{{video.snippet.description}}</p>
              </div>
            </template>
          </div>
        </core-header-panel>
      </section>

      <section>
        <div cross-fade>
          <template if="{{selectedVideoId}}">
            <google-youtube videoid="{{selectedVideoId}}"
                            chromeless
                            width="{{playerWidth}}"
                            height="{{playerHeight}}"
                            currenttime="{{currentTime}}"
                            currenttimeformatted="{{currentTimeFormatted}}"
                            fractionloaded="{{fractionLoaded}}"
                            state="{{state}}"
                            duration="{{duration}}"
                            durationformatted="{{durationFormatted}}"
                            hero-id="{{selectedVideoId}}"
                            hero>
            </google-youtube>
          </template>

          <paper-slider id="seekbar"
                        min="0"
                        max="{{duration}}"
                        value="{{currentTime}}"
                        secondaryProgress="{{ fractionLoaded * duration }}"
                        on-manual-change="{{handleSeekTo}}"
                        disabled?="{{duration == 0}}">
          </paper-slider>

          <core-toolbar id="playercontrols" class="{{ {'medium-tall': narrow} | tokenList }}">
            <paper-fab class="{{ {bottom: narrow, mini: true} | tokenList }}"
                       icon="arrow-back"
                       on-tap="{{handlePlayerClose}}">
            </paper-fab>

            <template if="{{state == 1 || state == 3}}">
              <paper-fab class="{{ {bottom: narrow, mini: true} | tokenList }}"
                         icon="av:pause"
                         on-tap="{{handlePause}}">
              </paper-fab>
            </template>

            <template if="{{state != 1 && state != 3}}">
              <paper-fab class="{{ {bottom: narrow, mini: true} | tokenList }}"
                         icon="av:play-arrow"
                         on-tap="{{handlePlay}}">
              </paper-fab>
            </template>

            <p flex>{{selectedVideoTitle}}</p>

            <p class="{{ {bottom: narrow} | tokenList }}" hidden?="{{duration == 0}}">{{currentTimeFormatted}}/{{durationFormatted}}</p>
          </core-toolbar>
        </div>
      </section>
    </core-animated-pages>

    <template if="{{searchParams}}">
      <core-ajax auto
                 url="https://www.googleapis.com/youtube/v3/search"
                 params="{{searchParams}}"
                 handleAs="json"
                 on-core-response="{{handleSearchResponse}}">
      </core-ajax>
    </template>
  </template>

  <script>
    (function() {
      var SEARCH_PARAM_REGEX = /searchparam/i;

      Polymer('google-youtube-video-wall', {
        // TODO: Add JSDoc for the published attributes and clean up attribute names.
        headerTitle: 'YouTube Videos',
        showSearch: false,
        maxItems: 500,
        key: 'AIzaSyAcB7qNYPC6bI7e3PHscV8w5-acmocWhmE',
        channelId: '',
        location: '',
        locationRadius: '',
        maxResults: 50,
        order: 'relevance',
        publishedAfter: '',
        publishedBefore: '',
        q: '',
        safeSearch: 'moderate',
        topicId: '',
        videoCategoryId: '',

        // Placeholder, since the YT Player doesn't like being initialized without a video id.
        selectedVideoId: 'mN7IAaRdi_k',
        selectedVideoTitle: '',
        nextPageToken: '',
        youtubeApiSearchParams: '',

        updateYouTubeApiSearchParams: function() {
          var params = {
            part: 'snippet',
            pageToken: this.nextPageToken,
            type: 'video',
            videoEmbeddable: 'true',
            key: this.key,
            maxResults: this.maxResults,
            channelId: this.channelId,
            location: this.location,
            locationRadius: this.locationRadius,
            order: this.order,
            q: this.q,
            safeSearch: this.safeSearch,
            topicId: this.topicId,
            videoCategoryId: this.videoCategoryId
          };

          Object.keys(params).forEach(function(key) {
            if (params[key] === '') {
              delete(params[key]);
            }
          });

          this.searchParams = JSON.stringify(params);
        },

        handleSearchResponse: function(e) {
          var response = e.detail.response;

          // If there are already some results and this is the next page of results, concatenate.
          if (this.videos && this.nextPageToken) {
            this.videos = this.videos.concat(response.items);
          } else {
            this.videos = response.items;
          }

          if (response.nextPageToken && this.videos.length < this.maxItems) {
            this.nextPageToken = response.nextPageToken;
            this.async(this.updateYouTubeApiSearchParams);
          }
        },

        handleItemSelected: function(e) {
          this.selectedVideoTitle = e.srcElement.parentNode.dataset.videoTitle;
          this.selectedVideoId = e.srcElement.parentNode.dataset.videoId;
          this.$.corepage.selected = 1;
        },

        handlePlayerClose: function() {
          this.shadowRoot.querySelector('google-youtube').pause();
          this.$.corepage.selected = 0;

          this.state = -1;
          this.currentTime = 0;
          this.fractionLoaded = 0;
        },

        handlePlay: function() {
          this.shadowRoot.querySelector('google-youtube').play();
        },

        handlePause: function() {
          this.shadowRoot.querySelector('google-youtube').pause();
        },

        handleSeekTo: function() {
          this.shadowRoot.querySelector('google-youtube').seekTo(this.$.seekbar.value);
        },

        handleTransitionEnd: function() {
          // If we've transitioned from the player to the results page, reset selectedVideoId
          // so that the next <google-youtube> player element is "fresh".
          // We can't reset it prior to the transition since it will mess up the hero-id mapping.
          if (this.$.corepage.selected == 0) {
            this.selectedVideoId = '';
          }
        },

        observe: {
          'key channelId location locationRadius maxResults order publishedAfter publishedBefore q safeSearch topicId videoCategoryId': function() {
            this.nextPageToken = '';
            this.updateYouTubeApiSearchParams();
          }
        },

        ready: function() {
          // The video player should be in a 16:9 aspect ratio.
          this.playerWidth = '100%';
          // We need to read the width of the container rather than rely on the width of the player
          // itself, because the player is not yet on the page.
          this.playerHeight = (this.$.corepage.offsetWidth * 9 / 16) + 'px';

          this.updateYouTubeApiSearchParams();
        }
      });
    })();
  </script>
</polymer-element>
